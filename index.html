<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Robotic Arm BLE Controller â€“ Stable v3</title>
<style>
body{font-family:sans-serif;background:#0a0e27;color:#e2e8f0;margin:0;padding:20px;text-align:center}
h1{color:#60a5fa}
button{margin:5px;padding:10px 16px;font-weight:700;border:none;border-radius:8px;cursor:pointer;color:white;background:linear-gradient(135deg,#3b82f6,#2563eb)}
button:disabled{opacity:.5}
.range{width:80%;margin:10px auto}
.status{margin-top:10px;font-weight:600}
.good{color:#22c55e}.bad{color:#ef4444}.warn{color:#fbbf24}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;max-width:600px;margin:20px auto}
</style>
</head>
<body>
<h1>ðŸ¤– Robotic Arm BLE Controller</h1>

<div class="status bad" id="status">ðŸ”´ Disconnected</div>
<div style="margin:10px;">
  <button id="connect">ðŸ”Œ Connect</button>
  <button id="disconnect" disabled>Disconnect</button>
</div>

<h3>Manual Controls</h3>
<div class="grid">
  <button data-hold="A">Base Left</button>
  <button data-hold="D">Base Right</button>
  <button data-hold="W">Shoulder Up</button>
  <button data-hold="S">Shoulder Down</button>
  <button data-hold="Q">Elbow Up</button>
  <button data-hold="E">Elbow Down</button>
  <button data-cmd="O">Open Grip</button>
  <button data-cmd="C">Close Grip</button>
  <button data-cmd="STOP">STOP</button>
</div>

<h3>Servo Angles</h3>
<div>
  <label>Base: <span id="baseVal">90</span>Â°</label><br>
  <input type="range" id="base" class="range" min="0" max="180" value="90">
</div>
<div>
  <label>Shoulder: <span id="shoulderVal">90</span>Â°</label><br>
  <input type="range" id="shoulder" class="range" min="0" max="180" value="90">
</div>
<div>
  <label>Elbow: <span id="elbowVal">90</span>Â°</label><br>
  <input type="range" id="elbow" class="range" min="0" max="180" value="90">
</div>
<div>
  <label>Gripper: <span id="gripperVal">90</span>Â°</label><br>
  <input type="range" id="gripper" class="range" min="0" max="180" value="90">
</div>

<script>
const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
const CHARACTERISTIC_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb';

let device = null, characteristic = null, keepAliveTimer = null;

const statusEl = document.getElementById('status');
const connectBtn = document.getElementById('connect');
const disconnectBtn = document.getElementById('disconnect');

function setStatus(msg, state='bad'){
  statusEl.textContent = msg;
  statusEl.className = 'status ' + (state==='good'?'good':state==='warn'?'warn':'bad');
}

async function send(cmd){
  if (!characteristic) return;
  try{
    await characteristic.writeValueWithoutResponse(new TextEncoder().encode(cmd + '\n'));
    console.log('Sent:', cmd);
  }catch(e){
    console.warn('Write failed:', e);
    setStatus('âš ï¸ Lost connection', 'warn');
  }
}

async function connect(){
  try{
    setStatus('ðŸ” Scanning...', 'warn');
    device = await navigator.bluetooth.requestDevice({
      filters:[{ name:'RoboticArm_ESP32' }],
      optionalServices:[SERVICE_UUID]
    });
    device.addEventListener('gattserverdisconnected', onDisconnect);
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

    setStatus('ðŸŸ¢ Connected', 'good');
    connectBtn.disabled = true;
    disconnectBtn.disabled = false;

    // Keep connection alive every 2s
    keepAliveTimer = setInterval(()=> send('PING'),2000);

    // Initialize servo positions
    ['B90','SH90','EL90','G90'].forEach(cmd=>send(cmd));
  }catch(e){
    console.error(e);
    setStatus('âŒ Connection failed', 'bad');
  }
}

function onDisconnect(){
  setStatus('ðŸ”´ Disconnected', 'bad');
  connectBtn.disabled = false;
  disconnectBtn.disabled = true;
  characteristic = null;
  clearInterval(keepAliveTimer);
}

async function disconnect(){
  if(device && device.gatt.connected){
    await device.gatt.disconnect();
    setStatus('ðŸ”´ Disconnected', 'bad');
  }
  clearInterval(keepAliveTimer);
  connectBtn.disabled = false;
  disconnectBtn.disabled = true;
}

// Button listeners
connectBtn.onclick = connect;
disconnectBtn.onclick = disconnect;

// Command buttons
document.querySelectorAll('[data-cmd]').forEach(btn=>{
  btn.addEventListener('click', ()=> send(btn.dataset.cmd));
});

// Hold buttons (continuous movement)
document.querySelectorAll('[data-hold]').forEach(btn=>{
  const cmd = btn.dataset.hold;
  btn.addEventListener('mousedown', ()=>send(cmd));
  btn.addEventListener('mouseup', ()=>send('STOP'));
  btn.addEventListener('mouseleave', ()=>send('STOP'));
  btn.addEventListener('touchstart', (e)=>{e.preventDefault(); send(cmd);});
  btn.addEventListener('touchend', ()=>send('STOP'));
});

// Slider controls
function bindSlider(id, prefix){
  const el = document.getElementById(id);
  const valEl = document.getElementById(id+'Val');
  let timer=null;
  el.addEventListener('input', ()=>{
    valEl.textContent = el.value;
    clearTimeout(timer);
    timer=setTimeout(()=> send(prefix+el.value),100);
  });
}
bindSlider('base','B');
bindSlider('shoulder','SH');
bindSlider('elbow','EL');
bindSlider('gripper','G');

// Auto reconnect attempt every 5s if lost
setInterval(()=>{
  if(device && !characteristic && !connectBtn.disabled){
    console.log('Attempting auto reconnect...');
    connect();
  }
},5000);
</script>
</body>
</html>
