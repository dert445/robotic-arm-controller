<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>F1 Car BLE Control</title>
  <style>
    body {
      background: radial-gradient(circle, #111, #000);
      color: white;
      text-align: center;
      font-family: 'Poppins', sans-serif;
      overflow: hidden;
      padding: 20px;
    }

    h1 {
      margin-top: 10px;
      font-size: 1.6rem;
    }

    #status {
      color: #00bfff;
      font-size: 1rem;
      margin: 10px 0;
    }

    #connectBtn {
      background: #00bfff;
      border: none;
      color: white;
      padding: 10px 20px;
      font-size: 1.1rem;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
    }

    #connectBtn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .joysticks {
      display: flex;
      justify-content: space-around;
      margin-top: 40px;
      flex-wrap: wrap;
    }

    .joystick-container {
      margin: 10px;
    }

    .joystick-label {
      font-size: 0.9rem;
      margin-bottom: 5px;
      color: #aaa;
    }

    canvas {
      background: #222;
      border: 2px solid #555;
      border-radius: 50%;
      touch-action: none;
    }

    .buttons {
      margin-top: 40px;
    }

    button {
      background: #333;
      border: none;
      color: white;
      padding: 12px 24px;
      font-size: 1rem;
      margin: 8px;
      border-radius: 10px;
      cursor: pointer;
    }

    button:hover {
      background: #555;
    }

    button:active {
      transform: scale(0.95);
    }

    .super {
      background: #ff4444;
    }

    .super.active {
      background: #ff0000;
      box-shadow: 0 0 20px #ff0000;
    }

    .stop {
      background: #ff8800;
    }

    #values {
      margin-top: 20px;
      font-size: 0.9rem;
      color: #888;
    }
  </style>
</head>
<body>

  <h1>ðŸš— F1 Car BLE Controller</h1>
  <div id="status">Not Connected</div>
  <button id="connectBtn">ðŸ”— Connect to ESP32 F1 Car</button>

  <div class="joysticks">
    <div class="joystick-container">
      <div class="joystick-label">THROTTLE</div>
      <canvas id="moveJoy" width="200" height="200"></canvas>
    </div>
    <div class="joystick-container">
      <div class="joystick-label">STEERING</div>
      <canvas id="steerJoy" width="200" height="200"></canvas>
    </div>
  </div>

  <div class="buttons">
    <button id="stopBtn" class="stop">â›” STOP</button>
    <button id="superBtn" class="super">âš¡ SUPER SPEED</button>
  </div>

  <div id="values">Throttle: 0% | Steering: 0% | Mode: Normal</div>

  <script>
    // BLE UUIDs matching ESP32 code
    const SERVICE_UUID = "19B10000-E8F2-537E-4F6C-D104768A1214";
    const CHARACTERISTIC_UUID = "19B10001-E8F2-537E-4F6C-D104768A1214";

    let bleDevice;
    let bleCharacteristic;
    let isConnected = false;

    let moveCanvas = document.getElementById("moveJoy");
    let steerCanvas = document.getElementById("steerJoy");
    let ctx1 = moveCanvas.getContext("2d");
    let ctx2 = steerCanvas.getContext("2d");

    let center1 = { x: 100, y: 100 };
    let center2 = { x: 100, y: 100 };
    let moveJoy = { x: 100, y: 100 };
    let steerJoy = { x: 100, y: 100 };

    let radius = 80;
    let throttleValue = 0;
    let steerValue = 0;
    let superSpeed = false;
    let stopPressed = false;

    // Draw joystick
    function drawJoystick(ctx, joy, center) {
      ctx.clearRect(0, 0, 200, 200);
      
      // Outer circle
      ctx.beginPath();
      ctx.arc(center.x, center.y, radius, 0, Math.PI * 2);
      ctx.strokeStyle = "#888";
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Center point
      ctx.beginPath();
      ctx.arc(center.x, center.y, 3, 0, Math.PI * 2);
      ctx.fillStyle = "#666";
      ctx.fill();
      
      // Joystick handle
      ctx.beginPath();
      ctx.arc(joy.x, joy.y, 25, 0, Math.PI * 2);
      ctx.fillStyle = "#00bfff";
      ctx.fill();
      ctx.strokeStyle = "#0088cc";
      ctx.lineWidth = 3;
      ctx.stroke();
    }

    drawJoystick(ctx1, moveJoy, center1);
    drawJoystick(ctx2, steerJoy, center2);

    // --- BLE Connection ---
    document.getElementById("connectBtn").addEventListener("click", async () => {
      try {
        document.getElementById("status").textContent = "Scanning...";
        
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ name: "ESP32 F1 Car" }],
          optionalServices: [SERVICE_UUID]
        });

        document.getElementById("status").textContent = "Connecting...";
        const server = await bleDevice.gatt.connect();
        
        const service = await server.getPrimaryService(SERVICE_UUID);
        bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
        
        isConnected = true;
        document.getElementById("status").textContent = "âœ… Connected to ESP32 F1 Car";
        document.getElementById("connectBtn").disabled = true;
        
        // Handle disconnection
        bleDevice.addEventListener('gattserverdisconnected', () => {
          isConnected = false;
          document.getElementById("status").textContent = "âŒ Disconnected";
          document.getElementById("connectBtn").disabled = false;
        });

      } catch (error) {
        document.getElementById("status").textContent = "âš ï¸ Connection failed";
        alert("Bluetooth connection failed: " + error);
      }
    });

    // --- Touch Controls for Throttle Joystick ---
    function handleMoveTouch(x, y) {
      let dx = x - center1.x;
      let dy = y - center1.y;
      let dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist > radius) {
        let angle = Math.atan2(dy, dx);
        x = center1.x + radius * Math.cos(angle);
        y = center1.y + radius * Math.sin(angle);
      }
      
      moveJoy = { x, y };
      drawJoystick(ctx1, moveJoy, center1);
      
      // Calculate throttle (-100 to 100, inverted Y axis)
      throttleValue = Math.round(-(y - center1.y) / radius * 100);
      throttleValue = Math.max(-100, Math.min(100, throttleValue));
      
      sendBLEData();
    }

    moveCanvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      let rect = moveCanvas.getBoundingClientRect();
      let x = e.touches[0].clientX - rect.left;
      let y = e.touches[0].clientY - rect.top;
      handleMoveTouch(x, y);
    });

    moveCanvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      let rect = moveCanvas.getBoundingClientRect();
      let x = e.touches[0].clientX - rect.left;
      let y = e.touches[0].clientY - rect.top;
      handleMoveTouch(x, y);
    });

    moveCanvas.addEventListener("touchend", () => {
      moveJoy = { x: 100, y: 100 };
      drawJoystick(ctx1, moveJoy, center1);
      throttleValue = 0;
      sendBLEData();
    });

    // --- Touch Controls for Steering Joystick ---
    function handleSteerTouch(x, y) {
      let dx = x - center2.x;
      let dy = y - center2.y;
      let dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist > radius) {
        let angle = Math.atan2(dy, dx);
        x = center2.x + radius * Math.cos(angle);
        y = center2.y + radius * Math.sin(angle);
      }
      
      steerJoy = { x, y };
      drawJoystick(ctx2, steerJoy, center2);
      
      // Calculate steering (-100 to 100)
      steerValue = Math.round((x - center2.x) / radius * 100);
      steerValue = Math.max(-100, Math.min(100, steerValue));
      
      sendBLEData();
    }

    steerCanvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      let rect = steerCanvas.getBoundingClientRect();
      let x = e.touches[0].clientX - rect.left;
      let y = e.touches[0].clientY - rect.top;
      handleSteerTouch(x, y);
    });

    steerCanvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      let rect = steerCanvas.getBoundingClientRect();
      let x = e.touches[0].clientX - rect.left;
      let y = e.touches[0].clientY - rect.top;
      handleSteerTouch(x, y);
    });

    steerCanvas.addEventListener("touchend", () => {
      steerJoy = { x: 100, y: 100 };
      drawJoystick(ctx2, steerJoy, center2);
      steerValue = 0;
      sendBLEData();
    });

    // --- Mouse support for desktop testing ---
    let isMouseDown1 = false;
    let isMouseDown2 = false;

    moveCanvas.addEventListener("mousedown", (e) => {
      isMouseDown1 = true;
      let rect = moveCanvas.getBoundingClientRect();
      let x = e.clientX - rect.left;
      let y = e.clientY - rect.top;
      handleMoveTouch(x, y);
    });

    moveCanvas.addEventListener("mousemove", (e) => {
      if (isMouseDown1) {
        let rect = moveCanvas.getBoundingClientRect();
        let x = e.clientX - rect.left;
        let y = e.clientY - rect.top;
        handleMoveTouch(x, y);
      }
    });

    moveCanvas.addEventListener("mouseup", () => {
      isMouseDown1 = false;
      moveJoy = { x: 100, y: 100 };
      drawJoystick(ctx1, moveJoy, center1);
      throttleValue = 0;
      sendBLEData();
    });

    steerCanvas.addEventListener("mousedown", (e) => {
      isMouseDown2 = true;
      let rect = steerCanvas.getBoundingClientRect();
      let x = e.clientX - rect.left;
      let y = e.clientY - rect.top;
      handleSteerTouch(x, y);
    });

    steerCanvas.addEventListener("mousemove", (e) => {
      if (isMouseDown2) {
        let rect = steerCanvas.getBoundingClientRect();
        let x = e.clientX - rect.left;
        let y = e.clientY - rect.top;
        handleSteerTouch(x, y);
      }
    });

    steerCanvas.addEventListener("mouseup", () => {
      isMouseDown2 = false;
      steerJoy = { x: 100, y: 100 };
      drawJoystick(ctx2, steerJoy, center2);
      steerValue = 0;
      sendBLEData();
    });

    // --- Buttons ---
    document.getElementById("stopBtn").addEventListener("click", () => {
      stopPressed = true;
      throttleValue = 0;
      steerValue = 0;
      moveJoy = { x: 100, y: 100 };
      steerJoy = { x: 100, y: 100 };
      drawJoystick(ctx1, moveJoy, center1);
      drawJoystick(ctx2, steerJoy, center2);
      sendBLEData();
      setTimeout(() => { stopPressed = false; }, 100);
    });

    document.getElementById("superBtn").addEventListener("click", () => {
      superSpeed = !superSpeed;
      document.getElementById("superBtn").classList.toggle("active", superSpeed);
      sendBLEData();
    });

    // --- Send BLE Data ---
    async function sendBLEData() {
      if (!isConnected || !bleCharacteristic) return;

      try {
        // Update display
        document.getElementById("values").textContent = 
          `Throttle: ${throttleValue}% | Steering: ${steerValue}% | Mode: ${superSpeed ? 'SUPER' : 'Normal'}`;

        // Pack data: [throttle+100, steer+100, flags]
        let data = new Uint8Array(3);
        data[0] = throttleValue + 100;  // 0-200 range
        data[1] = steerValue + 100;     // 0-200 range
        data[2] = (stopPressed ? 0x01 : 0) | (superSpeed ? 0x02 : 0);

        await bleCharacteristic.writeValueWithoutResponse(data);
      } catch (error) {
        console.error("BLE send error:", error);
      }
    }

    // Send data periodically to maintain connection
    setInterval(() => {
      if (isConnected) {
        sendBLEData();
      }
    }, 100);
  </script>
</body>
</html>
