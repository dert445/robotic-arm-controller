<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>F1 Car BLE Control</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background: radial-gradient(circle, #111, #000);
      color: white;
      font-family: 'Poppins', sans-serif;
      text-align: center;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
    }
    h1 { font-size: 1.8rem; margin-top: 10px; }
    #status { margin: 10px 0; color: #00bfff; }
    #connectBtn {
      background: #00bfff; border: none; color: #fff;
      padding: 10px 20px; font-size: 1rem; border-radius: 10px;
      cursor: pointer; transition: 0.3s;
    }
    #connectBtn:hover { background: #0099cc; }
    canvas {
      background: #222; border-radius: 50%; border: 2px solid #444;
      width: 150px; height: 150px; touch-action: none;
    }
    .joysticks { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
    .buttons { margin-top: 25px; display: flex; gap: 15px; }
    button {
      background: #333; color: #fff; border: none;
      padding: 10px 20px; font-weight: 600; border-radius: 10px; cursor: pointer;
    }
    .stop { background: #ff8800; }
    .super { background: #e63946; }
    .super.active { background: #ff0000; box-shadow: 0 0 15px red; }
    #values { margin-top: 15px; color: #aaa; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>üèéÔ∏è F1 Car BLE Controller</h1>
  <div id="status">Not Connected</div>
  <button id="connectBtn">üîó Connect</button>
  <div class="joysticks">
    <div>
      <div>Throttle</div>
      <canvas id="moveJoy" width="150" height="150"></canvas>
    </div>
    <div>
      <div>Steering</div>
      <canvas id="steerJoy" width="150" height="150"></canvas>
    </div>
  </div>
  <div class="buttons">
    <button class="stop" id="stopBtn">‚õî STOP</button>
    <button class="super" id="superBtn">‚ö° SUPER SPEED</button>
  </div>
  <div id="values">Throttle: 0% | Steering: 0% | Mode: Normal</div>

  <script>
    const SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
    const CHARACTERISTIC_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";

    let bleDevice, bleCharacteristic, isConnected = false;
    let throttle = 0, steer = 0, superSpeed = false, stopPressed = false;

    const moveCanvas = document.getElementById("moveJoy");
    const steerCanvas = document.getElementById("steerJoy");
    const ctx1 = moveCanvas.getContext("2d");
    const ctx2 = steerCanvas.getContext("2d");
    const size = 150, center = size / 2, radius = 50;

    function drawJoystick(ctx, x, y) {
      ctx.clearRect(0, 0, size, size);
      ctx.beginPath(); ctx.arc(center, center, radius + 20, 0, Math.PI * 2);
      ctx.strokeStyle = "#888"; ctx.stroke();
      ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI * 2);
      ctx.fillStyle = "#00bfff"; ctx.fill();
    }

    drawJoystick(ctx1, center, center);
    drawJoystick(ctx2, center, center);

    document.getElementById("connectBtn").addEventListener("click", async () => {
      try {
        document.getElementById("status").textContent = "Connecting...";
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });
        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
        isConnected = true;
        document.getElementById("status").textContent = "‚úÖ Connected!";
        bleDevice.addEventListener("gattserverdisconnected", () => {
          isConnected = false;
          document.getElementById("status").textContent = "‚ùå Disconnected";
        });
      } catch (err) {
        document.getElementById("status").textContent = "‚ö†Ô∏è Connection failed";
        console.error(err);
      }
    });

    function sendData() {
      if (!isConnected) return;
      const data = new Uint8Array(3);
      data[0] = throttle + 100;
      data[1] = steer + 100;
      data[2] = (stopPressed ? 0x01 : 0) | (superSpeed ? 0x02 : 0);
      bleCharacteristic.writeValueWithoutResponse(data);
      document.getElementById("values").textContent =
        `Throttle: ${throttle}% | Steering: ${steer}% | Mode: ${superSpeed ? "SUPER" : "Normal"}`;
    }

    function handleJoystick(canvas, ctx, type, e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      let dx = x - center, dy = y - center;
      const dist = Math.sqrt(dx * dx + dy * dy);
      const max = radius;
      if (dist > max) { dx *= max / dist; dy *= max / dist; }
      drawJoystick(ctx, center + dx, center + dy);
      if (type === "move") throttle = Math.round(-dy / max * 100);
      if (type === "steer") steer = Math.round(dx / max * 100);
      sendData();
    }

    [["moveJoy", ctx1, "move"], ["steerJoy", ctx2, "steer"]].forEach(([id, ctx, type]) => {
      const canvas = document.getElementById(id);
      ["mousedown", "touchstart"].forEach(evt => canvas.addEventListener(evt, e => handleJoystick(canvas, ctx, type, e)));
      ["mousemove", "touchmove"].forEach(evt => canvas.addEventListener(evt, e => handleJoystick(canvas, ctx, type, e)));
      ["mouseup", "mouseleave", "touchend"].forEach(evt => canvas.addEventListener(evt, () => {
        drawJoystick(ctx, center, center);
        if (type === "move") throttle = 0;
        if (type === "steer") steer = 0;
        sendData();
      }));
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
      stopPressed = true; throttle = 0; steer = 0; sendData(); setTimeout(() => stopPressed = false, 200);
    });
    document.getElementById("superBtn").addEventListener("click", () => {
      superSpeed = !superSpeed; document.getElementById("superBtn").classList.toggle("active", superSpeed); sendData();
    });

    setInterval(() => { if (isConnected) sendData(); }, 100);
  </script>
</body>
</html>
